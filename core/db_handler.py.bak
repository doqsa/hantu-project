import asyncio
import aiomysql
import os
from dotenv import load_dotenv

# ê²½ë¡œ ?¤ì •
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
ENV_FILE = os.path.join(BASE_DIR, '.env')
load_dotenv(ENV_FILE)

class DBHandler:
    def __init__(self, db_queue: asyncio.Queue):
        self.db_queue = db_queue
        self.pool = None
        self.is_running = False
        
        # .env?ì„œ DB ?•ë³´ ë¡œë“œ
        self.host = os.getenv("DB_HOST", "127.0.0.1")
        self.user = os.getenv("DB_USER")
        self.password = os.getenv("DB_PASSWORD")
        self.db_name = os.getenv("DB_NAME", "hantu_db")
        self.port = int(os.getenv("DB_PORT", 3306))

    async def _init_pool(self):
        """DB ?°ê²° ?€ ?ì„± (ë¹„ë™ê¸?"""
        try:
            self.pool = await aiomysql.create_pool(
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password,
                db=self.db_name,
                autocommit=True, # ë¡œê·¸???°ì´?°ëŠ” ?ë™ ì»¤ë°‹???±ëŠ¥??? ë¦¬
                charset='utf8mb4'
            )
            print(f"[DB] ?°ê²° ?€ ?ì„± ?„ë£Œ ({self.host}:{self.port})")
        except Exception as e:
            print(f"[ì¹˜ëª…???¤ë¥˜] DB ?°ê²° ?¤íŒ¨: {e}")
            raise e

    async def _insert_trade(self, conn, data):
        """KODEX 200 ì²´ê²° ?°ì´???€??""
        # [ì°¸ê³ : ?´ì „ ?˜ì • ? ì?] stck_prpr???¬ìš©
        sql = """
            INSERT INTO kodex200_trade (
                bsop_date, cntg_time, stck_prpr, prdy_vrss, prdy_ctrt,
                cntg_vol, acml_vol, acml_tr_pbmn, 
                stck_oprc, stck_hgpr, stck_lwpr, created_at
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """
        timestamp = data.get('timestamp')
        now_date = timestamp[:10].replace('-', '')
        now_time = timestamp[11:19].replace(':', '')
        
        # ?„ì¬ê°€??'?„ì¬ê°€' ?ëŠ” 'price' ?¤ì— ?ˆì„ ???ˆìŒ
        current_price = data.get('?„ì¬ê°€') or data.get('price', 0)
        
        args = (
            now_date, now_time, 
            current_price,                  # stck_prpr (?„ì¬ê°€)
            data.get('?„ì¼?€ë¹?, 0),          # prdy_vrss
            data.get('?±ë½ë¥?, 0.0),          # prdy_ctrt
            data.get('ì²´ê²°??, 0),            # cntg_vol
            data.get('?„ì ê±°ë˜??, 0),         # acml_vol
            data.get('?„ì ê±°ë˜?€ê¸?, 0),       # acml_tr_pbmn
            current_price,                  # stck_oprc (?œê? - ?„ì‹œë¡??„ì¬ê°€ ?¬ìš©)
            current_price,                  # stck_hgpr (ê³ ê? - ?„ì‹œë¡??„ì¬ê°€ ?¬ìš©)
            current_price,                  # stck_lwpr (?€ê°€ - ?„ì‹œë¡??„ì¬ê°€ ?¬ìš©)
            timestamp
        )
        async with conn.cursor() as cur:
            await cur.execute(sql, args)

    async def _insert_hoga(self, conn, data):
        """KODEX 200 ?¸ê? ë°?ë¶„ì„ ì§€???€??""
        # [?˜ì • ?„ë£Œ] SQL ì»¬ëŸ¼ ê°œìˆ˜?€ VALUES %s ê°œìˆ˜ 50ê°??¼ì¹˜?œí‚´
        sql = """
            INSERT INTO kodex200_hoga (
                bsop_date, hoga_time, 
                imbalance_ratio, wap_ask, wap_bid, resistance_wall, support_wall,
                ask_price_1, ask_vol_1, ask_price_2, ask_vol_2, ask_price_3, ask_vol_3, ask_price_4, ask_vol_4, ask_price_5, ask_vol_5,
                ask_price_6, ask_vol_6, ask_price_7, ask_vol_7, ask_price_8, ask_vol_8, ask_price_9, ask_vol_9, ask_price_10, ask_vol_10,
                bid_price_1, bid_vol_1, bid_price_2, bid_vol_2, bid_price_3, bid_vol_3, bid_price_4, bid_vol_4, bid_price_5, bid_vol_5,
                bid_price_6, bid_vol_6, bid_price_7, bid_vol_7, bid_price_8, bid_vol_8, bid_price_9, bid_vol_9, bid_price_10, bid_vol_10,
                total_ask_qty, total_bid_qty, created_at
            ) VALUES (
                %s, %s, 
                %s, %s, %s, %s, %s,
                %s, %s, %s, %s, %s, %s, %s, %s, %s, %s,
                %s, %s, %s, %s, %s, %s, %s, %s, %s, %s,
                %s, %s, %s, %s, %s, %s, %s, %s, %s, %s,
                %s, %s, %s, %s, %s, %s, %s, %s, %s, %s,
                %s, %s, %s
            )
        """
        timestamp = data.get('timestamp')
        now_date = timestamp[:10].replace('-', '')
        now_time = timestamp[11:19].replace(':', '')

        # ë§¤ê°œë³€??ë¦¬ìŠ¤??êµ¬ì„±
        args = [
            now_date, now_time,
            data.get('imbalance_ratio'), data.get('wap_ask'), data.get('wap_bid'),
            data.get('resistance_wall'), data.get('support_wall')
        ]
        
        # ë§¤ë„ 1~10?¨ê³„ (20ê°???ª©)
        for i in range(1, 11):
            args.append(data.get(f'ë§¤ë„?¸ê?{i}', 0))
            args.append(data.get(f'ë§¤ë„?¸ê??”ëŸ‰{i}', 0))
            
        # ë§¤ìˆ˜ 1~10?¨ê³„ (20ê°???ª©)
        for i in range(1, 11):
            args.append(data.get(f'ë§¤ìˆ˜?¸ê?{i}', 0))
            args.append(data.get(f'ë§¤ìˆ˜?¸ê??”ëŸ‰{i}', 0))
            
        # ì´ì”??ë°??€?„ìŠ¤?¬í”„ (3ê°???ª©) - ?„ë“œëª?total_ask_all/total_bid_allë¡??˜ì •
        args.append(data.get('total_ask_all', 0))
        args.append(data.get('total_bid_all', 0))
        args.append(timestamp)

        async with conn.cursor() as cur:
            await cur.execute(sql, tuple(args))

    async def _insert_futures(self, conn, data):
        """KOSPI 200 ? ë¬¼ ?°ì´???€??""
        # [ì°¸ê³ : ?´ì „ ?˜ì • ? ì?] current_price -> price ë¡?ë³€ê²?
        sql = """
            INSERT INTO kospi200_futures (
                bsop_date, cntg_time, futures_code,
                price, open_interest, volume, accum_volume,
                theory_price, basis, created_at
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """
        timestamp = data.get('timestamp')
        now_date = timestamp[:10].replace('-', '')
        now_time = timestamp[11:19].replace(':', '')
        
        # ?„ì¬ê°€??'?„ì¬ê°€' ?ëŠ” 'price' ?¤ì— ?ˆì„ ???ˆìŒ
        current_price = data.get('?„ì¬ê°€') or data.get('price', 0)
        
        args = (
            now_date, now_time,
            data.get('code', ''),
            current_price,
            data.get('ë¯¸ê²°?œì•½??, 0),
            data.get('ì²´ê²°??, 0),
            data.get('?„ì ê±°ë˜??, 0),
            data.get('?´ë¡ ê°€', 0.0),
            data.get('ê´´ë¦¬??, 0.0),
            timestamp
        )
        
        print(f"[DB] ? ë¬¼ ?°ì´???€?? ì½”ë“œ={data.get('code')}, ê°€ê²?{current_price}, ë¯¸ê²°??{data.get('ë¯¸ê²°?œì•½??)}")
        
        try:
            async with conn.cursor() as cur:
                await cur.execute(sql, args)
                print(f"[DB] ??? ë¬¼ ?°ì´???€???±ê³µ")
        except Exception as e:
            print(f"[DB] ??? ë¬¼ ?°ì´???€???¤íŒ¨: {e}")
            print(f"[DB] SQL: {sql}")
            print(f"[DB] Args: {args}")
            raise

    async def _insert_nav(self, conn, data):
        """iNAV ë°?ê´´ë¦¬???°ì´???€??(?¬ìš©???”ì²­ ì½”ë“œ ë°˜ì˜)"""
        # [ì°¸ê³ : ?´ì „ ?˜ì • ? ì?] current_price -> price ë¡?ë³€ê²?
        sql = """
            INSERT INTO kodex200_nav (
                bsop_date, check_time, price, nav, disparity, created_at
            ) VALUES (%s, %s, %s, %s, %s, %s)
        """
        timestamp = data.get('timestamp')
        now_date = timestamp[:10].replace('-', '') 
        now_time = timestamp[11:19].replace(':', '') 
        
        args = (
            now_date, now_time,
            data.get('price'),      
            data.get('nav'),
            data.get('disparity'),
            timestamp
        )
        async with conn.cursor() as cur:
            await cur.execute(sql, args)

    async def _insert_exchange(self, conn, data):
        """?˜ìœ¨ ?°ì´???€??(USD/KRW)"""
        sql = """
            INSERT INTO market_exchange (
                bsop_date, check_time, currency, rate, created_at
            ) VALUES (%s, %s, %s, %s, %s)
        """
        timestamp = data.get('timestamp')
        now_date = timestamp[:10].replace('-', '')
        now_time = timestamp[11:19].replace(':', '')

        args = (
            now_date, now_time,
            data.get('currency', 'USD'),
            data.get('rate'),
            timestamp
        )

        async with conn.cursor() as cur:
            await cur.execute(sql, args)

    async def run(self):
        """DB ?€??ë£¨í”„ ?œì‘"""
        await self._init_pool()
        self.is_running = True
        print("[DB] ë¹„ë™ê¸??€??ëª¨ë“ˆ ê°€???œì‘...")

        try:
            while self.is_running:
                try:
                    # ?ì—???°ì´???€ê¸?
                    packet = await self.db_queue.get()
                    
                    # ?œì? ?¬ë§·: {"table": "...", "data": {...}}
                    # ?˜ìœ¨/ê¸€ë¡œë²Œ ?°ì´?°ëŠ” dataë§??„ë‹¬?????ˆìœ¼ë¯€ë¡?? ì—°?˜ê²Œ ì²˜ë¦¬
                    if isinstance(packet, dict) and 'data' in packet:
                        table_name = packet.get('table')
                        data = packet.get('data')
                    else:
                        table_name = packet.get('table') if isinstance(packet, dict) else None
                        data = packet

                    if not data:
                        self.db_queue.task_done()
                        continue

                    # ?°ê²° ?€?ì„œ ì»¤ë„¥???ë“?˜ì—¬ ì¿¼ë¦¬ ?¤í–‰
                    async with self.pool.acquire() as conn:
                        if table_name == 'kodex200_trade':
                            await self._insert_trade(conn, data)
                        elif table_name == 'kodex200_hoga':
                            await self._insert_hoga(conn, data)
                        elif table_name == 'kospi200_futures':
                            await self._insert_futures(conn, data)
                        elif table_name == 'kodex200_nav': 
                            await self._insert_nav(conn, data)
                        elif data.get('type') == 'EXCHANGE':
                            await self._insert_exchange(conn, data)
                        elif data.get('type') == 'GLOBAL_MARKET':
                            pass  # TODO
                        elif data.get('type') == 'NAV':
                            await self._insert_nav(conn, data): ê¸€ë¡œë²Œ ?œì¥ ì§€???€???Œì´ë¸??°ë™
                        else:
                            pass # ?????†ëŠ” ?Œì´ë¸?

                    self.db_queue.task_done()
                    
                except Exception as e:
                    print(f"[DB ?ëŸ¬] ?€??ì¤??¤ë¥˜ ë°œìƒ: {e}")
                    # ?ëŸ¬ ë°œìƒ ??? ì‹œ ?€ê¸?
                    await asyncio.sleep(0.1)
        
        except asyncio.CancelledError:
            print("[DB] ?•ìƒ ì¢…ë£Œ??)
            raise
        except Exception as e:
            print(f"[DB] ?¬ê°???¤ë¥˜: {e}")

    def close(self):
        """DB ?°ê²° ?€ ì¢…ë£Œ"""
        self.is_running = False
        if self.pool is not None:
            self.pool.close()
            print("[DB] ?°ê²° ?€ ì¢…ë£Œ ?„ë£Œ")
